<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CAR/VEN METAR & TAF + Bonaire Visibility</title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #101820;
      color: #f2f2f2;
      margin: 0;
      padding: 24px;
      font-size: 1.6rem;
    }
    h1 {
      text-align: center;
      font-size: 2.8rem;
      margin-bottom: 0.5rem;
    }
    #timers {
      text-align: center;
      font-family: monospace;
      margin-bottom: 1rem;
    }
    #timers span {
      margin: 0 0.5rem;
    }
    #local-time, #utc-time {
      color: #66ffcc;
      font-size: 1.4rem;
      font-weight: bold;
    }
    #next-update {
      color: #999;
      font-family: monospace;
      font-size: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-family: monospace;
      font-size: 1.4rem;
      margin-top: 0.5rem;
    }
    th, td {
      padding: 12px;
      border: 1px solid #2a3b47;
      text-align: left;
      vertical-align: top;
      color: #f2f2f2;
    }
    th {
      background: #003b5a;
    }
    td.station-code {
      font-size: 1.8rem;
      color: #66ffcc;
    }
    .raw-row td {
      background: #1a1a1a;
      font-weight: normal;
    }
    .raw-code {
      margin: 0.5em 0 0;
      font-family: monospace;
      font-size: 1rem;
      white-space: pre-wrap;
      color: #999;
    }
    td.bold-time {
      background: #ffff99;
      color: #101820;
    }
    td.wx span {
      display: inline-block;
      margin-right: 0.4em;
      font-family: monospace;
    }
    td.wx span.light  { color: #ffff66; }
    td.wx span.normal { color: #66ffcc; }
    td.wx span.heavy  { color: #ff3333; }
    td.clouds span {
      display: inline-block;
      margin-right: 0.4em;
      font-family: monospace;
    }
    td.clouds span.nil { color: #999; }
    td.clouds span.tcu { text-decoration: underline; color: #ffcc00; }
    td.clouds span.cb  { font-weight: bold;     color: #ff6600; }
    #pressure-converter {
      margin: 1rem 0;
      font-family: monospace;
      font-size: 1rem;
      text-align: center;
    }
    #pressure-converter input {
      width: 5rem;
      padding: 4px;
      font-family: monospace;
      font-size: 1rem;
      text-align: right;
      margin: 0 0.5rem;
    }
    #bonaire-visibility {
      font-family: monospace;
      font-size: 1rem;
      text-align: center;
      color: #66ffcc;
      margin-bottom: 1rem;
    }
    #compact-taf {
      display: flex;
      flex-direction: column;
      font-family: monospace;
      font-size: 1rem;
      line-height: 1.2;
      border-top: 1px solid #2a3b47;
      padding-top: 8px;
      max-height: 15rem;
      overflow-y: auto;
    }
    #compact-taf div {
      margin-bottom: 0.4rem;
    }
    #compact-taf strong {
      display: inline-block;
      width: 50px;
      color: #66ffcc;
    }
    #compact-taf span {
      white-space: nowrap;
    }
  </style>
</head>
<body>

  <h1>CAR/VEN METAR & TAF</h1>

  <div id="timers">
    <span id="local-time">Local: --:--:--</span> |
    <span id="utc-time">UTC: --:--:--</span> |
    <span id="next-update">Next in: --s</span>
  </div>

  <table>
    <thead>
      <tr>
        <th>ICAO</th><th>Time</th><th>Wind</th><th>Vis</th>
        <th>Wx</th><th>Clouds</th><th>Temp/Dew</th><th>QNH</th>
      </tr>
    </thead>
    <tbody id="data">
      <tr><td colspan="8">Loading…</td></tr>
    </tbody>
  </table>

  <div id="pressure-converter">
    Pressure Converter:
    <label>hPa
      <input id="pressure-input" type="number" placeholder="hPa">
    </label>
    = <span id="pressure-output">-- inHg</span>
  </div>

  <div id="bonaire-visibility">Bonaire Visibility: –</div>

  <div id="compact-taf">Loading TAF…</div>

  <audio id="alarm"
         src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"
         preload="auto"></audio>

  <script>
    const dataEl     = document.getElementById('data'),
          visEl      = document.getElementById('bonaire-visibility'),
          tafEl      = document.getElementById('compact-taf'),
          alarmEl    = document.getElementById('alarm'),
          localTime  = document.getElementById('local-time'),
          utcTime    = document.getElementById('utc-time'),
          nextUpdate = document.getElementById('next-update'),
          pInput     = document.getElementById('pressure-input'),
          pOutput    = document.getElementById('pressure-output');

    const API_KEY       = 'fb135a94c0574db4b26082b70705b4af';
    const metarStations = ['TNCA','TNCB','TNCC','TNCM','SVMI','SVVA'];
    const tafStations   = ['TNCB','TNCC'];
    const watchStation  = 'TNCA';
    const wxCodes       = /[+-]?(?:VCSH|TS)/g;
    const cloudPattern  = /^(FEW|SCT|BKN|OVC)\d{3}(TCU|CB)?$/;
    let prevTimes       = {};
    const metarInterval = 30;
    let lastTs          = Date.now();

    function updateClocks() {
      const now = new Date(),
            pad = n => n.toString().padStart(2,'0'),
            elapsed = Math.floor((Date.now() - lastTs)/1000);
      localTime.textContent = `Local: ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
      utcTime.textContent   = `UTC: ${pad(now.getUTCHours())}:${pad(now.getUTCMinutes())}:${pad(now.getUTCSeconds())}`;
      nextUpdate.textContent = `Next in: ${Math.max(0, metarInterval - elapsed)}s`;
    }

    async function updateMetar() {
      try {
        const res  = await fetch(
          `https://api.checkwx.com/metar/${metarStations.join(',')}`,
          { headers: {'X-API-Key': API_KEY} }
        );
        const { data } = await res.json();
        let html = '', alert = false;

        data.forEach(raw => {
          const toks = raw.split(' '),
                code = toks[0] || '–',
                time = toks[1] || '–';
          let wind='–', vis='–', td='–', qnh='–', clouds=[];

          toks.slice(2).forEach(tok => {
            if (/KT$/.test(tok)) wind = tok;
            else if (/^\d{4}$/.test(tok)) vis = tok;
            else if (cloudPattern.test(tok) || tok === '///') clouds.push(tok);
            else if (/^M?\d{2}\/M?\d{2}$/.test(tok)) td = tok;
            else if (/^Q\d{4}$/.test(tok)) {
              const h = +tok.slice(1);
              qnh = `${h} – ${(h * 0.02953).toFixed(2)}`;
            }
          });

          const gm = wind.match(/G(\d{2,3})/);
          const gustVal = gm ? +gm[1] : 0;
          const wxMatch = raw.match(wxCodes) || [];
          const hasTS   = wxMatch.some(w => w.includes('TS'));

          const wxDisplay = wxMatch.length
            ? wxMatch.map(w => {
                const cls = w.startsWith('+') ? 'heavy'
                          : w.startsWith('-') ? 'light'
                          : 'normal';
                return `<span class="${cls}">${w}</span>`;
              }).join('')
            : '–';

          const cloudsDisplay = clouds.length
            ? clouds.map(c => {
                let cls = '';
                if (c === '///') cls = 'nil';
                if (/TCU/.test(c)) cls = 'tcu';
                if (/CB/.test(c))  cls = 'cb';
                return `<span class="${cls}">${c}</span>`;
              }).join('')
            : '–';

          const changed = time !== prevTimes[code];
          prevTimes[code] = time;

          if (code === watchStation && (gustVal >= 35 || hasTS)) alert = true;

          html += `
            <tr>
              <td class="station-code">${code}</td>
              <td class="${changed?'bold-time':''}">${time}</td>
              <td>${wind}</td>
              <td>${vis}</td>
              <td class="wx">${wxDisplay}</td>
              <td class="clouds">${cloudsDisplay}</td>
              <td>${td}</td>
              <td>${qnh}</td>
            </tr>
            <tr class="raw-row">
              <td colspan="8"><pre class="raw-code">${raw}</pre></td>
            </tr>`;
        });

        dataEl.innerHTML = html;
        if (alert) alarmEl.play();
        lastTs = Date.now();
      } catch {
        dataEl.innerHTML = `<tr><td colspan="8">⚠️ Error loading METAR</td></tr>`;
      }
    }

    async function updateTaf() {
      try {
        const res = await fetch(
          `https://api.checkwx.com/taf/${tafStations.join(',')}`,
          { headers: {'X-API-Key': API_KEY} }
        );
        const { data } = await res.json();
        tafEl.innerHTML = data.map(raw => {
          const code    = raw.split(' ')[0] || '–';
          const compact = raw.replace(`${code} `, '');
          return `<div><strong>${code}:</strong> <span>${compact}</span></div>`;
        }).join('');
      } catch {
        tafEl.textContent = '⚠️ Error loading TAF';
      }
    }

    async function updateBonaireVis() {
      try {
        const proxy  = 'https://api.allorigins.win/raw?url=';
        const target = encodeURIComponent('https://www.knmidc.org/weather/bonaire/?Current');
        const res    = await fetch(proxy + target);
        const text   = await res.text();
        const doc    = new DOMParser().parseFromString(text, 'text/html');
        const row    = Array.from(doc.querySelectorAll('tr'))
                          .find(tr => tr.textContent.includes('Visibility (m)'));
        let v = '–';
        if (row) {
          const cell = row.querySelectorAll('td')[1];
          if (cell) v = cell.textContent.trim();
        }
        visEl.textContent = `Bonaire Visibility: ${v}`;
      } catch {
        visEl.textContent = 'Bonaire Visibility: n/a';
      }
    }

    function initPressureConverter() {
      pInput.addEventListener('input', () => {
        const hpa = parseFloat(pInput.value);
        pOutput.textContent = !isNaN(hpa)
          ? `${(hpa * 0.02953).toFixed(2)} inHg`
          : '-- inHg';
      });
    }

    initPressureConverter();
    updateClocks();
    updateMetar();
    updateTaf();
    updateBonaireVis();

    setInterval(updateClocks, 1000);
    setInterval(() => {
      updateMetar();
      updateBonaireVis();
    }, metarInterval * 1000);
  </script>

</body>
</html>
