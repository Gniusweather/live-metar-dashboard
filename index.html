<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CAR/VEN & Bonaire METAR & TAF</title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #101820;
      color: #f2f2f2;
      margin: 0;
      padding: 24px;
      font-size: 1.6rem;
    }
    h1 {
      text-align: center;
      font-size: 2.8rem;
      margin-bottom: 0.5rem;
    }
    #timers {
      text-align: center;
      font-family: monospace;
      margin-bottom: 0.5rem;
      font-size: 1.6rem;
    }
    #timers span { margin: 0 0.5rem; }
    #local-time, #utc-time {
      color: #66ffcc;
      font-weight: bold;
    }
    #next-update {
      color: #999;
      font-size: 1.2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-family: monospace;
      font-size: 1.4rem;
      margin-top: 0.5rem;
    }
    th, td {
      padding: 12px;
      border: 1px solid #2a3b47;
      vertical-align: top;
    }
    th {
      background: #003b5a;
      color: #f2f2f2;
    }
    td {
      color: #f2f2f2;
    }
    td.station-code {
      font-size: 1.8rem;
      color: #66ffcc;
    }
    td.station-code.alert {
      background-color: #660000;
      color: #ffcccc;
    }
    td.bold-time {
      background: #ffff99;
      color: #101820;
    }
    td.low-vis, td.gust {
      color: #66ffcc;
    }
    .raw-row td {
      background: #1a1a1a;
      padding: 16px;
    }
    .raw-code {
      font-family: monospace;
      font-size: 1.4rem;
      white-space: pre-wrap;
      color: #999;
      margin: 0.5em 0 0;
    }
    td.wx span {
      display: inline-block;
      margin-right: 0.4em;
      color: #66ffcc;
      font-family: monospace;
    }
    td.clouds span {
      display: inline-block;
      margin-right: 0.4em;
      font-family: monospace;
    }
    td.clouds span.nil    { color: #999; }
    td.clouds span.normal { color: #fff; }
    td.clouds span.tcu,
    td.clouds span.cb     { color: #66ffcc; }

    #pressure-converter {
      margin: 1rem 0;
      text-align: center;
      font-family: monospace;
      font-size: 1rem;
    }
    #pressure-converter input {
      width: 5rem;
      padding: 4px;
      font-family: monospace;
      font-size: 1rem;
      text-align: right;
      margin: 0 0.5rem;
    }

    #bonaire-visibility {
      text-align: center;
      font-family: monospace;
      margin-bottom: 1rem;
      color: #66ffcc;
      font-size: 1.2rem;
    }

    #compact-taf {
      margin-top: 1rem;
      font-family: monospace;
      font-size: 1.2rem;
      line-height: 1.4;
      border-top: 1px solid #2a3b47;
      padding-top: 8px;
      max-height: 15rem;
      overflow-y: auto;
    }
    #compact-taf div { margin-bottom: 0.4rem; }
    #compact-taf strong {
      display: inline-block;
      width: 50px;
      color: #66ffcc;
    }
    #compact-taf span { white-space: nowrap; }

    #alert-toggle {
      display: block;
      margin: 2rem auto 1rem;
      font-family: monospace;
      font-size: 1.2rem;
      background: #004466;
      color: #ffffff;
      border: 2px solid #66ffcc;
      border-radius: 6px;
      padding: 10px 20px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    #alert-toggle:hover {
      background: #006699;
    }

    #alert-history {
      display: none;
      font-family: monospace;
      font-size: 1.2rem;
      max-height: 200px;
      overflow-y: auto;
      border-top: 1px solid #2a3b47;
      padding-top: 1rem;
    }
    #alert-history h2 {
      font-size: 1.6rem;
      color: #ff9999;
      margin-bottom: 0.5rem;
    }
    #alert-log li {
      margin-bottom: 0.5rem;
      color: #ffcccc;
    }
  </style>
</head>
<body>

  <h1>CAR/VEN & Bonaire METAR & TAF</h1>

  <div id="timers">
    <span id="local-time">Local: --:--:--</span> |
    <span id="utc-time">UTC: --:--:--</span> |
    <span id="next-update">Next in: --s</span>
  </div>

  <table>
    <thead>
      <tr>
        <th>ICAO</th><th>Time</th><th>Wind</th><th>Vis</th>
        <th>Wx</th><th>Clouds</th><th>Temp/Dew</th><th>QNH</th>
      </tr>
    </thead>
    <tbody id="data">
      <tr><td colspan="8">Loading‚Ä¶</td></tr>
    </tbody>
  </table>

  <div id="pressure-converter">
    Pressure Converter:
    <label>hPa
      <input id="pressure-input" type="number" placeholder="hPa">
    </label>
    = <span id="pressure-output">-- inHg</span>
  </div>

  <div id="bonaire-visibility">Bonaire Visibility: ‚Äì</div>

  <div id="compact-taf">Loading TAF‚Ä¶</div>

  <button id="alert-toggle" onclick="toggleAlertHistory()">Show Alert History</button>
  <div id="alert-history">
    <h2>üö® Alert History</h2>
    <ul id="alert-log"></ul>
  </div>

  <audio id="alarm"
         src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"
         preload="auto"></audio>

  <script>
    const API_KEY        = 'fb135a94c0574db4b26082b70705b4af';
    const metarStations  = ['TNCA','TNCB','TNCC','TNCM','SVMI','SVVA','TNCS'];
    const tafStations    = ['TNCB','TNCC'];
    const watchStation   = 'TNCA';
    const metarInterval  = 30;
    const cloudPattern   = /^(FEW|SCT|BKN|OVC)\d{3}(TCU|CB)?$/;
    const wxRegex        = /^(?:\+|-)?(?:VC)?(?:MI|PR|BC|DR|BL|SH|TS|FZ)?(?:DZ|RA|SN|SG|IC|PL|GR|GS|UP|BR|FG|FU|DU|SA|HZ|PY|PO|SQ|FC|SS|DS)$/;

    let prevTimes       = {};
    let lastTs          = Date.now();

    const dataEl        = document.getElementById('data');
    const visEl         = document.getElementById('bonaire-visibility');
    const tafEl         = document.getElementById('compact-taf');
    const alertLogEl    = document.getElementById('alert-log');
    const alertToggleEl = document.getElementById('alert-toggle');
    const localTimeEl   = document.getElementById('local-time');
    const utcTimeEl     = document.getElementById('utc-time');
    const nextUpdateEl  = document.getElementById('next-update');
    const pInput        = document.getElementById('pressure-input');
    const pOutput       = document.getElementById('pressure-output');

    function toggleAlertHistory() {
      const section = document.getElementById('alert-history');
      const isHidden = section.style.display === 'none' || section.style.display === '';
      section.style.display = isHidden ? 'block' : 'none';
      alertToggleEl.textContent = isHidden ? 'Hide Alert History' : 'Show Alert History';
    }

    function updateClocks() {
      const now = new Date();
      const pad = n => n.toString().padStart(2,'0');
      const elapsed = Math.floor((Date.now() - lastTs)/1000);
      localTimeEl.textContent  = `Local: ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
      utcTimeEl.textContent    = `UTC: ${pad(now.getUTCHours())}:${pad(now.getUTCMinutes())}:${pad(now.getUTCSeconds())}`;
      nextUpdateEl.textContent = `Next in: ${Math.max(0, metarInterval - elapsed)}s`;
    }

    async function updateMetar() {
      try {
        const res  = await fetch(
          `https://api.checkwx.com/metar/${metarStations.join(',')}`,
          { headers: { 'X-API-Key': API_KEY } }
        );
        const json = await res.json();
        const list = json.data || [];

        let html = '', alert = false;

        list.forEach(raw => {
          const toks      = raw.split(' ');
          const code      = toks[0] || '‚Äì';
          const time      = toks[1] || '‚Äì';
          let wind='‚Äì', vis='‚Äì', td='‚Äì', qnh='‚Äì';
          let clouds = [], wxMatch = [];

          for (let tok of toks.slice(2)) {
            if (/^Q\d{4}$/.test(tok)) {
              const h = +tok.slice(1);
              qnh = `${h} ‚Äì ${(h * 0.02953).toFixed(2)}`;
              break;
            }
            if (/KT$/.test(tok)) wind = tok;
            else if (/^\d{4}$/.test(tok)) vis = tok;
            else if (cloudPattern.test(tok) || tok === '///') clouds.push(tok);
            else if (/^M?\d{2}\/M?\d{2}$/.test(tok)) td = tok;
            else if (wxRegex.test(tok)) wxMatch.push(tok);
          }

          const gustVal      = +(wind.match(/G(\d{2,3})/)||[])[1] || 0;
          const visVal       = /^\d+$/.test(vis) ? +vis : 9999;
          const visAlert     = visVal <= 5000;
          const windAlert    = gustVal >= 35;
          const weatherAlert = wxMatch.length > 0;
          const stationAlert = windAlert || weatherAlert || visAlert;
          if (code === watchStation && stationAlert) alert = true;

          if (stationAlert) {
            const timestamp = new Date().toLocaleString();
            const reasons = [];
            if (windAlert) reasons.push(`üí® Gust ${gustVal}KT`);
            if (visAlert)  reasons.push(`üå´Ô∏è Vis ${vis}m`);
            if (weatherAlert) reasons.push(`‚õàÔ∏è Wx: ${wxMatch.join(', ')}`);
            const entry = `${timestamp} ‚Äì ${code}: ${reasons.join(', ')}`;
            const li = document.createElement('li');
            li.textContent = entry;
            alertLogEl.prepend(li);
          }

          if (code === 'TNCS') {
            visEl.textContent = `Bonaire Visibility: ${vis} meters`;
          }

          const changed = time !== prevTimes[code];
          prevTimes[code] = time;

          const wxDisplay = wxMatch.length
            ? wxMatch.map(w => `<span>${w}</span>`).join(' ')
            : '‚Äì';

          const cloudsDisplay = clouds.length
            ? clouds.map(c => {
                let cls = '';
                if (/TCU/.test(c)) cls = 'tcu';
                if (/CB/.test(c))  cls = 'cb';
                return `<span class="${cls}">${c}</span>`;
              }).join(' ')
            : '‚Äì';

          html += `
            <tr>
              <td class="station-code ${stationAlert?'alert':''}">${code}</td>
              <td class="${changed?'bold-time':''}">${time}</td>
              <td class="${windAlert?'gust':''}">${wind}</td>
              <td class="${visAlert?'low-vis':''}">${vis}</td>
              <td class="wx">${wxDisplay}</td>
              <td class="clouds">${cloudsDisplay}</td>
              <td>${td}</td>
              <td>${qnh}</td>
            </tr>
            <tr class="raw-row">
              <td colspan="8"><pre class="raw-code">${raw}</pre></td>
            </tr>`;
        });

        dataEl.innerHTML = html;
        if (alert) document.getElementById('alarm').play();
        lastTs = Date.now();
      } catch {
        dataEl.innerHTML = `<tr><td colspan="8">‚ö†Ô∏è Error loading METAR</td></tr>`;
      }
    }

    async function updateBonaireVis() {
      try {
        const proxy  = 'https://api.allorigins.win/raw?url=';
        const target = encodeURIComponent('https://www.knmidc.org/weather/bonaire/?Current');
        const res    = await fetch(proxy + target);
        const text   = await res.text();
        const doc    = new DOMParser().parseFromString(text, 'text/html');
        const row    = Array.from(doc.querySelectorAll('tr'))
                          .find(tr => tr.textContent.includes('Visibility (m)'));
        let v = '‚Äì';
        if (row) {
          const cell = row.querySelectorAll('td')[1];
          if (cell) v = cell.textContent.trim();
        }
        visEl.textContent = `Bonaire Visibility: ${v}`;
      } catch {
        visEl.textContent = 'Bonaire Visibility: n/a';
      }
    }

    async function updateTaf() {
      try {
        const res  = await fetch(
          `https://api.checkwx.com/taf/${tafStations.join(',')}`,
          { headers: { 'X-API-Key': API_KEY } }
        );
        const json = await res.json();
        const list = json.data || [];
        let html = '';
        list.forEach(raw => {
          const st = raw.split(' ')[0];
          html += `<div><strong>${st}:</strong> <span>${raw}</span></div>`;
        });
        tafEl.innerHTML = html;
      } catch {
        tafEl.innerHTML = '‚ö†Ô∏è Error loading TAF';
      }
    }

    function initPressureConverter() {
      pInput.addEventListener('input', () => {
        const hpa = parseFloat(pInput.value);
        pOutput.textContent = !isNaN(hpa)
          ? `${(hpa * 0.02953).toFixed(2)} inHg`
          : '-- inHg';
      });
    }

    initPressureConverter();
    updateClocks();
    updateMetar();
    updateTaf();
    updateBonaireVis();

    setInterval(updateClocks, 1000);
    setInterval(() => {
      updateMetar();
      updateBonaireVis();
    }, metarInterval * 1000);
  </script>

</body>
</html>
