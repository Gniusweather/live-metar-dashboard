<!-- Updated: Raw METAR now non-bold; TAF from TNCB and TNCC displayed in compact format -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CAR/VEN METAR & TAF + Bonaire Visibility</title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #101820;
      color: #f2f2f2;
      margin: 0;
      padding: 24px;
      font-size: 1.6rem;
    }
    h1 {
      text-align: center;
      font-size: 2.8rem;
      margin-bottom: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-family: monospace;
      font-size: 1.4rem;
      margin-top: 1rem;
    }
    th, td {
      padding: 12px;
      border: 1px solid #2a3b47;
      text-align: left;
      font-weight: bold;
      color: #f2f2f2;
    }
    th {
      background: #003b5a;
      color: #fff;
    }
    td.station-code {
      font-size: 1.8rem;
      color: #66ffcc;
    }
    td.alert {
      background: #850000;
      color: #fff;
    }
    td.bold-time {
      background: #ffff99;
      color: #101820;
    }
    tr.raw-row td {
      background: #1a1a1a;
      font-weight: normal;
    }
    .raw-code {
      font-family: monospace;
      font-size: 1.2rem;
      white-space: pre-wrap;
    }
    #bonaire-visibility {
      margin-top: 1rem;
      text-align: center;
      font-family: monospace;
    }
    #bonaire-visibility .label {
      color: #999;
      font-size: 1rem;
    }
    #vis-value {
      font-size: 1.6rem;
      font-weight: bold;
      color: #ff9900;
    }
    #compact-taf {
      margin-top: 1rem;
      font-family: monospace;
      font-size: 1rem;
      line-height: 1.4;
      border-top: 1px solid #2a3b47;
      padding-top: 8px;
    }
    #compact-taf div {
      margin-bottom: 0.5rem;
    }
    #compact-taf strong {
      display: inline-block;
      width: 50px;
      color: #66ffcc;
    }
    #compact-taf pre {
      display: inline;
      margin: 0;
      white-space: nowrap;
    }
  </style>
</head>
<body>

  <h1>CAR/VEN METAR & TAF</h1>
  <table>
    <thead>
      <tr>
        <th>ICAO</th><th>Time</th><th>Wind</th><th>Vis</th>
        <th>Wx</th><th>Clouds</th><th>Temp/Dew</th><th>QNH</th>
      </tr>
    </thead>
    <tbody id="data">
      <tr><td colspan="8">Loading…</td></tr>
    </tbody>
  </table>

  <div id="bonaire-visibility">
    <span class="label">Bonaire Visibility (m):</span>
    <span id="vis-value">–</span>
  </div>

  <div id="compact-taf">Loading TAF…</div>

  <audio id="alarm" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script>
    const dataEl = document.getElementById('data'),
          visEl  = document.getElementById('vis-value'),
          tafEl  = document.getElementById('compact-taf'),
          alarmEl = document.getElementById('alarm');

    const API_KEY = 'fb135a94c0574db4b26082b70705b4af';
    const metarStations = ['TNCA','TNCB','TNCC','TNCM','SVMI','SVVA'];
    const tafStations   = ['TNCB','TNCC'];
    const watchStation  = 'TNCA';
    const wxCodes = /\b(?:VCSH|VC|TSRA|TS|SHRA|SH|RA|DZ|BR|FG|SQ|PO|FC)\b/g;

    const prevTimes = {};

    async function updateMetar() {
      try {
        const res = await fetch(
          `https://api.checkwx.com/metar/${metarStations.join(',')}`,
          { headers: { 'X-API-Key': API_KEY } }
        );
        const { data } = await res.json();
        let html = '';
        let alert = false;

        data.forEach(raw => {
          const t = raw.split(' ');
          const code = t[0] || '–';
          const time = t[1] || '–';
          let wind = '–', ws = 0, wg = 0, vis = '–';
          let wx = '–', cl = [], td = '–', qnh = '–';

          const wxMatch = raw.match(wxCodes) || [];
          if (wxMatch.length) wx = wxMatch.join(' ');

          t.slice(2).forEach(tok => {
            if (/KT$/.test(tok)) wind = tok;
            else if (/^\d{4}$/.test(tok)) vis = tok;
            else if (/^(FEW|SCT|BKN|OVC)\d{3}(TCU|CB)?$/.test(tok)) cl.push(tok);
            else if (/^M?\d{2}\/M?\d{2}$/.test(tok)) td = tok;
            else if (/^Q\d{4}$/.test(tok)) {
              const h = +tok.slice(1);
              qnh = `${h} – ${(h*0.02953).toFixed(2)}`;
            }
          });

          const changed = time !== prevTimes[code];
          prevTimes[code] = time;

          const alarmCondition = code === watchStation && (wind.includes('G') || wx.includes('TS') || wx.includes('SH') || wx.includes('VCSH'));
          if (alarmCondition) alert = true;

          html += `<tr>
            <td class="station-code">${code}</td>
            <td class="${changed?'bold-time':''}">${time}</td>
            <td class="${alarmCondition?'alert':''}">${wind}</td>
            <td>${vis}</td>
            <td class="${alarmCondition?'alert':''}">${wx}</td>
            <td>${cl.join(' ') || '–'}</td>
            <td>${td}</td>
            <td>${qnh}</td>
          </tr>`;
          html += `<tr class="raw-row">
            <td colspan="8"><pre class="raw-code">${raw}</pre></td>
          </tr>`;
        });

        dataEl.innerHTML = html;
        if (alert) alarmEl.play();
      } catch {
        dataEl.innerHTML = `<tr><td colspan="8">⚠️ Error loading METAR</td></tr>`;
      }
    }

    async function updateTaf() {
      try {
        const res = await fetch(
          `https://api.checkwx.com/taf/${tafStations.join(',')}`,
          { headers: { 'X-API-Key': API_KEY } }
        );
        const { data } = await res.json();
        let html = '';
        data.forEach(raw => {
          const code = raw.split(' ')[0] || '–';
          html += `<div><strong>${code}</strong><pre>${raw}</pre></div>`;
        });
        tafEl.innerHTML = html;
      } catch {
        tafEl.textContent = '⚠️ Error loading TAF';
      }
    }

    async function updateBonaireVis() {
      try {
        const proxy  = 'https://api.allorigins.win/raw?url=';
        const target = encodeURIComponent('https://www.knmidc.org/weather/bonaire/?Current');
        const res    = await fetch(proxy + target);
        const text   = await res.text();
        const doc    = new DOMParser().parseFromString(text,'text/html');
        const row    = Array.from(doc.querySelectorAll('tr'))
                          .find(tr => tr.textContent.includes('Visibility (m)'));
        let v = '–';
        if (row) {
          const cell = row.querySelectorAll('td')[1];
          if (cell) v = cell.textContent.trim();
        }
        visEl.textContent = v;
        if (v === '37000') visEl.classList.add('highlight');
        else               visEl.classList.remove('highlight');
      } catch {
        visEl.textContent = 'n/a';
      }
    }

    updateMetar();      setInterval(updateMetar, 30000);
    updateTaf();        setInterval(updateTaf, 300000);
    updateBonaireVis(); setInterval(updateBonaireVis, 60000);
  </script>
</body>
</html>
