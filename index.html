<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Caribbean & Venezuela METAR Dashboard</title>
  <style>
    body {
      background-color: #101820;
      color: #f2f2f2;
      margin: 0;
      padding: 40px;
      font-family: 'Segoe UI', Verdana, sans-serif;
      font-size: 1.4rem;
      transition: background-color 0.3s, color 0.3s;
    }
    h1 {
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    #clocks {
      text-align: center;
      font-size: 1.2rem;
      margin-bottom: 20px;
      color: #8ecfff;
    }
    .theme-toggle {
      text-align: center;
      margin-bottom: 30px;
    }
    .theme-toggle label {
      font-size: 1.2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0 auto 40px;
      font-size: 1.5rem;
      user-select: text;
    }
    th, td {
      padding: 16px;
      border: 1px solid #2a3b47;
      text-align: left;
    }
    th {
      background-color: #003b5a;
      color: white;
      font-size: 1.6rem;
    }
    tr:hover {
      background-color: #1c2a35;
    }
    .alert-gust {
      background-color: #5c1e1e;
      color: #fff;
      font-weight: bold;
    }
    .alert-weather {
      background-color: #5a4a00;
      color: #fff;
      font-weight: bold;
    }
    .converter {
      max-width: 300px;
      margin: 0 auto 60px;
      background: #00243a;
      padding: 15px;
      border-radius: 6px;
    }
    .converter h3 {
      margin: 0 0 10px;
      color: #8ecfff;
      font-size: 1.4rem;
    }
    .converter input {
      width: 100%;
      padding: 8px;
      font-size: 1rem;
      margin-bottom: 10px;
    }
    .converter button {
      width: 100%;
      padding: 8px;
      background: #007acc;
      color: white;
      border: none;
      font-size: 1rem;
      cursor: pointer;
    }
    .converter p {
      margin-top: 10px;
      font-size: 1.2rem;
      color: #f2f2f2;
    }
    .radar {
      text-align: center;
      margin: 40px auto;
    }
    .radar iframe {
      border: none;
      width: 100%;
      max-width: 700px;
      height: 500px;
    }
    footer {
      text-align: center;
      font-size: 1.1rem;
      color: #aaa;
    }

    /* Light Mode Styles */
    body.light-mode {
      background-color: #f2f2f2;
      color: #101820;
    }
    body.light-mode table th {
      background-color: #d0d0d0;
      color: #101820;
    }
    body.light-mode table td {
      background-color: #ffffff;
      color: #101820;
    }
    body.light-mode .converter {
      background-color: #e0e0e0;
    }
    body.light-mode footer {
      color: #333;
    }
    body.light-mode #clocks {
      color: #003b5a;
    }
  </style>
</head>
<body>

<h1>Caribbean & Venezuela – Raw METAR Reports</h1>

<div id="clocks">
  UTC Time: <span id="utc-time">Loading...</span> &nbsp;|&nbsp;
  Local Time: <span id="local-time">Loading...</span>
</div>

<div class="theme-toggle">
  <label>
    <input type="checkbox" id="themeToggle" style="transform: scale(1.3); margin-right: 8px;" />
    Toggle Light/Dark Mode
  </label>
</div>

<table>
  <thead>
    <tr>
      <th>Airport</th>
      <th>Raw METAR</th>
    </tr>
  </thead>
  <tbody id="metar-data">
    <tr><td colspan="2">Loading METAR data...</td></tr>
  </tbody>
</table>

<div class="converter">
  <h3>hPa → inHg</h3>
  <input id="hpaInput" type="number" step="0.1" placeholder="Enter hPa" />
  <button onclick="convertPressure()">Convert</button>
  <p id="inhgResult"></p>
</div>

<div class="radar">
  <h3 style="color: #8ecfff;">Live Radar – Curaçao</h3>
  <iframe src="https://www.meteo.cw/rad_loop.php" allowfullscreen></iframe>
</div>

<footer>
  &copy; 2025 Caribbean & Venezuela Aviation Weather
</footer>

<script>
  const stations = ['TNCA', 'TNCB', 'TNCC', 'TNCM', 'SVMI', 'SVVA'];
  const names = {
    TNCA: 'Aruba (TNCA)',
    TNCB: 'Bonaire (TNCB)',
    TNCC: 'Curaçao (TNCC)',
    TNCM: 'St. Maarten (TNCM)',
    SVMI: 'Caracas (SVMI)',
    SVVA: 'Valencia (SVVA)'
  };
  const tbody = document.getElementById('metar-data');
  const alertSound = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

  async function fetchRawMetars() {
    try {
      const res = await fetch(`https://api.checkwx.com/metar/${stations.join(',')}`, {
        headers: { 'X-API-Key': 'fb135a94c0574db4b26082b70705b4af' }
      });
      const json = await res.json();

      let shouldAlert = false;

      const rows = json.data.map(raw => {
        const code = raw.split(' ')[0];
        const label = names[code] || code;

        const isGust = /G\d{2,}/.test(raw);
        const isWeather = /(TS|RA|SH|FG|BR|SN|DZ|SQ|FC|GR|GS|HZ|DU|SA|VA|SS|DS)/.test(raw);

        let className = '';
        if (isGust) {
          className = 'alert-gust';
          shouldAlert = true;
        } else if (isWeather) {
          className = 'alert-weather';
          shouldAlert = true;
        }

        return `<tr><td>${label}</td><td class="${className}">${raw}</td></tr>`;
      }).join('');

      tbody.innerHTML = rows;

      if (shouldAlert) {
        alertSound.play().catch(() => {});
      }
    } catch (err) {
      console.error('Error loading METAR:', err);
      tbody.innerHTML = `<tr><td colspan="2">⚠️ Error loading data. Check connection or API key.</td></tr>`;
    }
  }

  function convertPressure() {
    const hpa = parseFloat(document.getElementById('hpaInput').value);
    const inhg = hpa * 0.02953;
    document.getElementById('inhgResult').textContent =
      isNaN(inhg) ? '—' : `${hpa} – ${inhg.toFixed(2)}`;
  }

  function updateClocks() {
    const now = new Date();
    const utc = now.toUTCString().replace('GMT', 'UTC');
    const local = now.toLocaleString();
    document.getElementById('utc-time').textContent = utc;
    document.getElementById('local-time').textContent = local;
  }

  // Theme toggle logic
  const toggle = document.getElementById('themeToggle');
  const currentTheme = localStorage.getItem('theme');
  if (currentTheme === 'light') {
    document.body.classList.add('light-mode');
    toggle.checked = true;
  }
  toggle.addEventListener('change', () => {
    document.body.classList.toggle('light-mode');
    localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
  });

  fetchRawMetars();
  setInterval(fetchRawMetars, 5 * 60 * 1000); // Refresh every 5 min
