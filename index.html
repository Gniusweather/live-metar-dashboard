<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Caribbean & Venezuela METAR Dashboard</title>
  <style>
    /* ... (unchanged styles from your previous version) ... */
  </style>
</head>
<body>

  <h1>Caribbean & Venezuela ‚Äì Raw METAR Reports</h1>
  <div id="clocks">
    UTC Time: <span id="utc-time">‚Äì</span> |
    Local Time: <span id="local-time">‚Äì</span>
  </div>
  <div id="countdown">
    Next update in: <span id="timer">‚Äì</span>
  </div>

  <div class="theme-toggle">
    <label>
      <input type="checkbox" id="themeToggle" />
      Toggle Light/Dark Mode
    </label>
  </div>

  <div id="alert-toggle">Show Alerts</div>
  <div id="alert-log">
    <strong>üìã Recent Alerts</strong>
    <hr />
  </div>

  <table>
    <thead>
      <tr>
        <th>Airport</th>
        <th>Time (UTC)</th>
        <th>Raw METAR</th>
        <th>QNH (hPa ‚Äì inHg)</th>
      </tr>
    </thead>
    <tbody id="metar-data">
      <tr><td colspan="4">Loading METAR data‚Ä¶</td></tr>
    </tbody>
  </table>

  <footer>&copy; 2025 Caribbean & Venezuela Aviation Weather</footer>

  <script>
    const stations = ['TNCA','TNCB','TNCC','TNCM','SVMI','SVVA'];
    const alertStations = ['TNCA','TNCB','TNCC'];

    const tbody       = document.getElementById('metar-data');
    const alertLogEl  = document.getElementById('alert-log');
    const toggleBtn   = document.getElementById('alert-toggle');
    const timerEl     = document.getElementById('timer');

    const speciSound   = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
    const gustSound    = new Audio('https://actions.google.com/sounds/v1/cartoon/cartoon_bird.ogg');
    const thunderSound = new Audio('https://actions.google.com/sounds/v1/weather/thunder_crack.ogg');

    let alertHistory = [];
    let countdown = 30;
    let intervalID;

    function logAlert(message) {
      const time = new Date().toLocaleTimeString();
      alertHistory.unshift(`‚Ä¢ ${time} ‚Äì ${message}`);
      if (alertHistory.length > 10) alertHistory.pop();
      alertLogEl.innerHTML = `<strong>üìã Recent Alerts</strong><hr/>` +
        alertHistory.join('<br/>');
    }

    toggleBtn.onclick = () => {
      const showing = alertLogEl.style.display === 'block';
      alertLogEl.style.display = showing ? 'none' : 'block';
      toggleBtn.textContent = showing ? 'Show Alerts' : 'Hide Alerts';
    };

    async function fetchMetars() {
      try {
        const res = await fetch(
          `https://api.checkwx.com/metar/${stations.join(',')}`, {
            headers: { 'X-API-Key':'fb135a94c0574db4b26082b70705b4af' }
          }
        );
        const json = await res.json();

        const rows = json.data.map(raw => {
          const [code, time='‚Äì', ...rest] = raw.split(' ');
          const text = [code,time,...rest].join(' ');
          const isSpeci = raw.startsWith('SPECI');
          const hasGust = !!raw.match(/\bG\d{1,2}\b/);
          const hasTS   = raw.includes('TS');
          const isAlert = alertStations.includes(code);
          const cls     = isSpeci ? 'alert-speci' : '';

          let qnhDisplay = '‚Äì';
          const m = raw.match(/Q(\d{4})/);
          if (m) {
            const hpa  = parseInt(m[1],10);
            const inhg = (hpa*0.02953).toFixed(2);
            qnhDisplay = `${hpa} - ${inhg}`;
          }

          if (isAlert) {
            if (isSpeci) {
              speciSound.play().catch(()=>{});
              logAlert(`${code}: SPECI`);
            }
            if (hasTS) {
              thunderSound.play().catch(()=>{});
              logAlert(`${code}: Thunderstorm`);
            }
            if (hasGust) {
              gustSound.play().catch(()=>{});
              logAlert(`${code}: Gusts`);
            }
          }

          return `<tr>
            <td>${code}</td>
            <td>${time}</td>
            <td class="${cls}">${text}</td>
            <td>${qnhDisplay}</td>
          </tr>`;
        }).join('');

        tbody.innerHTML = rows;
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="4">‚ö†Ô∏è Error loading METAR data</td></tr>`;
      }
    }

    function updateClocks() {
      const now = new Date();
      document.getElementById('utc-time').textContent =
        now.toUTCString().replace('GMT','UTC');
      document.getElementById('local-time').textContent =
        now.toLocaleString();
    }

    function updateCountdown() {
      const min = Math.floor(countdown / 60);
      const sec = countdown % 60;
      timerEl.textContent = `${min}:${sec.toString().padStart(2,'0')}`;
      countdown--;
      if (countdown < 0) {
        countdown = 30;
        fetchMetars();
      }
    }

    const tog = document.getElementById('themeToggle');
    if (localStorage.getItem('theme') === 'light') {
      document.body.classList.add('light-mode');
      tog.checked = true;
    }
    tog.addEventListener('change', () => {
      const light = document.body.classList.toggle('light-mode');
      localStorage.setItem('theme', light ? 'light' : 'dark');
    });

    // Initialize
    fetchMetars(); updateClocks();
    setInterval(updateClocks, 1000);
    intervalID = setInterval(updateCountdown, 1000);
  </script>

</body>
</html>
