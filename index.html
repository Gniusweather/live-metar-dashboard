<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CAR/VEN METAR AND TAF</title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #101820;
      color: #f2f2f2;
      margin: 0;
      padding: 24px;
      font-size: 1.6rem;
    }

    h1 {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    button,
    #alert-toggle {
      display: block;
      margin: 0.5rem auto;
      font-family: monospace;
      font-size: 1rem;
      background: #004466;
      color: #ffffff;
      border: 1px solid #66ffcc;
      border-radius: 4px;
      padding: 6px 12px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover,
    #alert-toggle:hover {
      background: #006699;
    }

    #timers {
      text-align: center;
      font-family: monospace;
      margin-bottom: 0.5rem;
      font-size: 1.6rem;
    }
    #timers span { margin: 0 0.5rem; }
    #current-date, #local-time, #utc-time {
      color: #66ffcc;
      font-weight: bold;
    }
    #next-update {
      color: #999;
      font-size: 1.2rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-family: monospace;
      font-size: 1.4rem;
      margin-top: 0.5rem;
    }
    th, td {
      padding: 12px;
      border: 1px solid #2a3b47;
      vertical-align: top;
    }
    th {
      background: #003b5a;
      color: #f2f2f2;
    }
    td {
      color: #f2f2f2;
    }
    td.station-code {
      font-size: 1.8rem;
      color: #66ffcc;
    }
    td.station-code.alert {
      background-color: #660000;
      color: #ffcccc;
    }
    td.bold-time {
      background: #ffff99;
      color: #101820;
    }
    td.low-vis,
    td.gust {
      color: #66ffcc;
    }
    td.wx span {
      display: inline-block;
      margin-right: 0.4em;
      font-family: monospace;
      color: #66ffcc;
    }
    td.clouds span {
      display: inline-block;
      margin-right: 0.4em;
      font-family: monospace;
    }
    td.clouds span.nil    { color: #999; }
    td.clouds span.normal { color: #fff; }
    td.clouds span.tcu,
    td.clouds span.cb     { color: #66ffcc; }
    .raw-row td {
      background: #1a1a1a;
      padding: 16px;
    }
    .raw-code {
      font-family: monospace;
      font-size: 1.4rem;
      white-space: pre-wrap;
      color: #999;
      margin: 0.5em 0 0;
    }

    #pressure-converter {
      text-align: center;
      font-family: monospace;
      font-size: 1rem;
      margin: 1rem auto;
    }
    #pressure-converter input {
      width: 60px;
      padding: 2px 4px;
      font-size: 1rem;
      text-align: right;
      border: 1px solid #66ffcc;
      border-radius: 4px;
      background: #101820;
      color: #f2f2f2;
    }
    #pressure-output {
      margin-left: 0.5rem;
      font-size: 1rem;
      color: #ffff99;
    }

    #bonaire-visibility {
      text-align: center;
      font-family: monospace;
      margin-bottom: 1rem;
      color: #66ffcc;
      font-size: 1.2rem;
    }

    #compact-taf {
      margin-top: 1rem;
      font-family: monospace;
      font-size: 1.2rem;
      line-height: 1.4;
      border-top: 1px solid #2a3b47;
      padding-top: 8px;
      max-height: 15rem;
      overflow-y: auto;
    }
    #compact-taf div { margin-bottom: 0.4rem; }
    #compact-taf strong {
      display: inline-block;
      width: 50px;
      color: #66ffcc;
    }
    #compact-taf span { white-space: nowrap; }

    /* Smaller alert history fonts */
    #alert-history h2 {
      font-size: 1.4rem;
      color: #ff9999;
      margin-bottom: 0.5rem;
    }
    #alert-log li {
      font-size: 1rem;
      margin: 0.25rem 0;
      color: #ffcccc;
    }
  </style>
</head>
<body>

  <button id="mode-toggle">Switch to Test Mode</button>
  <h1>CAR/VEN METAR AND TAF</h1>

  <div id="timers">
    <span id="current-date">Date: --------</span> |
    <span id="local-time">Local: --:--:--</span> |
    <span id="utc-time">UTC: --:--:--</span> |
    <span id="next-update">Next in: --s</span>
  </div>

  <table>
    <thead>
      <tr>
        <th>ICAO</th><th>Time</th><th>Wind</th><th>Vis</th>
        <th>Wx</th><th>Clouds</th><th>Temp/Dew</th><th>QNH</th>
      </tr>
    </thead>
    <tbody id="data">
      <tr><td colspan="8">Loading‚Ä¶</td></tr>
    </tbody>
  </table>

  <div id="pressure-converter">
    <label>Pressure (hPa): <input id="pressure-input" type="number" placeholder="1013"></label>
    <span id="pressure-output">-- inHg</span>
  </div>

  <div id="bonaire-visibility">Bonaire Visibility: ‚Äì</div>
  <div id="compact-taf">Loading TAF‚Ä¶</div>

  <button id="alert-toggle" onclick="toggleAlertHistory()">Show Alert History</button>
  <div id="alert-history">
    <h2>üö® Alert History</h2>
    <ul id="alert-log"></ul>
  </div>

  <audio id="alarm"
         src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg"
         preload="auto"></audio>

  <script>
    const API_KEY = 'fb135a94c0574db4b26082b70705b4af';
    const metarStations = ['TNCA','TNCB','TNCC','TNCM','SVMI','SVVA','TNCS'];
    const tafStations = ['TNCB','TNCC'];
    const watchStation = 'TNCA';
    const metarInterval = 30;

    const testMetarData = [
      "TNCA 010300Z 04015G40KT 4500 +TSRA OVC020CB 20/18 Q1012",
      "TNCB 010300Z 03010KT 3000 -RA SCT025TCU 22/19 Q1011",
      "TNCC 010300Z 02020G50KT 2000 +TSRA FEW016/// 24/22 Q1013",
      "TNCM 010300Z 05012G38KT 7000 FG BKN015CB 23/21 Q1010",
      "SVMI 010300Z 00005KT 5000 BR FEW012TCU 25/23 Q1009",
      "SVVA 010300Z 02007KT 4000 RA SCT020CB 24/22 Q1008",
      "TNCS 010300Z 01000KT 2000 FG FEW016/// 24/22 Q1015"
    ];
    const testTafData = [
      "TNCB 010300Z 0103/0206 00000KT P6SM FEW020",
      "TNCC 010300Z 0103/0206 02005KT P6SM SCT020"
    ];

    let isLive = true;
    let prevTimes = {};
    let lastTs = Date.now();
    const alertStates = {};

    const modeToggleEl = document.getElementById('mode-toggle');
    const dataEl       = document.getElementById('data');
    const visEl        = document.getElementById('bonaire-visibility');
    const tafEl        = document.getElementById('compact-taf');
    const alertLogEl   = document.getElementById('alert-log');
    const dateEl       = document.getElementById('current-date');
    const localTimeEl  = document.getElementById('local-time');
    const utcTimeEl    = document.getElementById('utc-time');
    const nextUpdateEl = document.getElementById('next-update');
    const pInput       = document.getElementById('pressure-input');
    const pOutput      = document.getElementById('pressure-output');

    modeToggleEl.addEventListener('click', () => {
      isLive = !isLive;
      modeToggleEl.textContent = isLive
        ? 'Switch to Test Mode'
        : 'Switch to Live Mode';
      updateClocks();
      updateMetar();
      updateTaf();
      updateBonaireVis();
    });

    function toggleAlertHistory() {
      const section = document.getElementById('alert-history');
      const isHidden = !section.style.display || section.style.display === 'none';
      section.style.display = isHidden ? 'block' : 'none';
      document.getElementById('alert-toggle').textContent =
        isHidden ? 'Hide Alert History' : 'Show Alert History';
    }

    function updateClocks() {
      const now = new Date();
      const pad = n => n.toString().padStart(2,'0');
      dateEl.textContent = `Date: ${pad(now.getDate())}-${pad(now.getMonth()+1)}-${now.getFullYear()}`;
      localTimeEl.textContent = `Local: ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
      utcTimeEl.textContent   = `UTC: ${pad(now.getUTCHours())}:${pad(now.getUTCMinutes())}:${pad(now.getUTCSeconds())}`;
      const elapsed = Math.floor((Date.now() - lastTs) / 1000);
      nextUpdateEl.textContent = `Next in: ${Math.max(0, metarInterval - elapsed)}s`;
    }

    async function updateMetar() {
      try {
        const rawList = isLive
          ? await fetch(`https://api.checkwx.com/metar/${metarStations.join(',')}`, {
              headers: { 'X-API-Key': API_KEY }
            }).then(r => r.json()).then(j => j.data || [])
          : testMetarData;

        let html = '';
        rawList.forEach(raw => {
          const toks = raw.split(' ');
          const code = toks[0] || '‚Äì';
          const time = toks[1] || '‚Äì';
          let wind='‚Äì', vis='‚Äì', td='‚Äì', qnh='‚Äì';
          let clouds = [], wxMatch = [];

          for (let tok of toks.slice(2)) {
            if (/^Q\d{4}$/.test(tok)) {
              const h = +tok.slice(1);
              qnh = `${h} ‚Äì ${(h*0.02953).toFixed(2)}`;
              continue;
            }
            if (/KT$/.test(tok)) wind = tok;
            else if (/^\d{4}$/.test(tok)) vis = tok;
            else if (/^(FEW|SCT|BKN|OVC)\d{3}(TCU|CB|\/{3})?$/.test(tok) || tok==='///')
              clouds.push(tok);
            else if (/^M?\d{2}\/M?\d{2}$/.test(tok)) td = tok;
            else if (/^(?:\+|-)?(?:VC)?(?:MI|PR|BC|DR|BL|SH|TS|FZ)?(?:DZ|RA|SN|SG|IC|PL|GR|GS|UP|BR|FG|FU|DU|SA|HZ|PY|PO|SQ|FC|SS|DS)$/.test(tok))
              wxMatch.push(tok);
          }

          const gustVal  = +(wind.match(/G(\d{2,3})/)||[])[1] || 0;
          const visVal   = /^\d+$/.test(vis) ? +vis : 9999;
          const visAlert     = visVal <= 5000;
          const windAlert    = gustVal >= 35;
          const weatherAlert = wxMatch.length > 0;
          const stationAlert = visAlert || windAlert || weatherAlert;

          if (!alertStates[code] && stationAlert) {
            alertStates[code] = true;
            if (code === watchStation) document.getElementById('alarm').play();
            const reasons = [];
            if (windAlert)    reasons.push(`üí® Gust ${gustVal}KT`);
            if (visAlert)     reasons.push(`üå´Ô∏è Vis ${vis}m`);
            if (weatherAlert) reasons.push(`‚õàÔ∏è Wx: ${wxMatch.join(', ')}`);
            const li = document.createElement('li');
            li.textContent = `${new Date().toLocaleString()} ‚Äì ${code}: ${reasons.join(', ')}`;
            alertLogEl.prepend(li);
          }
          if (alertStates[code] && !stationAlert) {
            alertStates[code] = false;
          }

          if (code === 'TNCS') {
            visEl.textContent = `Bonaire Visibility: ${vis} meters`;
          }

          const changed = time !== prevTimes[code];
          prevTimes[code] = time;

          const wxDisplay = wxMatch.length
            ? wxMatch.map(w => `<span>${w}</span>`).join(' ')
            : '‚Äì';
          const cloudsDisplay = clouds.length
            ? clouds.map(c => {
                const cls = /TCU/.test(c) ? 'tcu'
                          : /CB/.test(c)  ? 'cb'
                          : '';
                return `<span class="${cls}">${c}</span>`;
              }).join(' ')
            : '‚Äì';

          html += `
            <tr>
              <td class="station-code ${stationAlert?'alert':''}">${code}</td>
              <td class="${changed?'bold-time':''}">${time}</td>
              <td class="${windAlert?'gust':''}">${wind}</td>
              <td class="${visAlert?'low-vis':''}">${vis}</td>
              <td class="wx">${wxDisplay}</td>
              <td class="clouds">${cloudsDisplay}</td>
              <td>${td}</td><td>${qnh}</td>
            </tr>
            <tr class="raw-row">
              <td colspan="8"><pre class="raw-code">${raw}</pre></td>
            </tr>`;
        });

        dataEl.innerHTML = html;
        lastTs = Date.now();
      } catch {
        dataEl.innerHTML = `<tr><td colspan="8">‚ö†Ô∏è Error loading METAR</td></tr>`;
      }
    }

    async function updateBonaireVis() {
      if (!isLive) {
        visEl.textContent = 'Bonaire Visibility: 4500 meters (test)';
        return;
      }
      try {
        const proxy  = 'https://api.allorigins.win/raw?url=';
        const target = encodeURIComponent('https://www.knmidc.org/weather/bonaire/?Current');
        const text   = await fetch(proxy + target).then(r => r.text());
        const doc    = new DOMParser().parseFromString(text,'text/html');
        const row    = Array.from(doc.querySelectorAll('tr'))
                          .find(tr => tr.textContent.includes('Visibility (m)'));
        let v = '‚Äì';
        if (row) v = row.querySelectorAll('td')[1]?.textContent.trim();
        visEl.textContent = `Bonaire Visibility: ${v}`;
      } catch {
        visEl.textContent = 'Bonaire Visibility: n/a';
      }
    }

    async function updateTaf() {
      try {
        const list = isLive
          ? await fetch(`https://api.checkwx.com/taf/${tafStations.join(',')}`, {
              headers: { 'X-API-Key': API_KEY }
            }).then(r => r.json()).then(j => j.data || [])
          : testTafData;

        tafEl.innerHTML = list.map(raw => {
          const st = raw.split(' ')[0];
          return `<div><strong>${st}:</strong> <span>${raw}</span></div>`;
        }).join('');
      } catch {
        tafEl.textContent = '‚ö†Ô∏è Error loading TAF';
      }
    }

    pInput.addEventListener('input', () => {
      const hpa = parseFloat(pInput.value);
      pOutput.textContent = !isNaN(hpa)
        ? `${(hpa*0.02953).toFixed(2)} inHg`
        : '-- inHg';
    });

    updateClocks();
    updateMetar();
    updateTaf();
    updateBonaireVis();
    setInterval(updateClocks, 1000);
    setInterval(() => {
      updateMetar();
      updateBonaireVis();
    }, metarInterval * 1000);
  </script>
</body>
</html>
