<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Caribbean METAR – Full Weather Display</title>
  <style>
    body {
      background-color: #101820;
      color: #f2f2f2;
      margin: 0;
      font-family: 'Segoe UI', Verdana, sans-serif;
      font-size: 1.4rem;
    }
    header {
      background: #00243a;
      padding: 30px;
      text-align: center;
      font-size: 3rem;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 40px auto;
      font-size: 1.5rem;
      min-width: 1150px;
      user-select: text;
    }
    th, td {
      padding: 20px;
      border: 1px solid #2a3b47;
      text-align: left;
    }
    th {
      background-color: #003b5a;
      color: white;
    }
    tr:hover {
      background-color: #1c2a35;
    }
    .alert-gust {
      background-color: #5c1e1e;
      color: #fff;
      font-weight: bold;
    }
    .alert-weather {
      background-color: #5a4a00;
      color: #fff;
      font-weight: bold;
    }
    footer {
      background-color: #00243a;
      color: #ccc;
      text-align: center;
      padding: 20px;
      font-size: 1.2rem;
    }
    footer a {
      color: #8ecfff;
      text-decoration: none;
    }
  </style>
</head>
<body>

<header>Caribbean Airports – Live METAR</header>

<table>
  <thead>
    <tr>
      <th>Parameter</th>
      <th>TNCA – Aruba</th>
      <th>TNCB – Bonaire</th>
      <th>TNCC – Curaçao</th>
      <th>TNCM – St. Maarten</th>
    </tr>
  </thead>
  <tbody id="metar-data">
    <tr><td colspan="5">Loading METAR data...</td></tr>
  </tbody>
</table>

<footer>
  &copy; 2025 Caribbean Aviation Weather &nbsp;|&nbsp;
  <a href="https://www.meteo.cw" target="_blank">Visit Meteo Curaçao</a>
</footer>

<script>
  const stations = ['TNCA', 'TNCB', 'TNCC', 'TNCM'];
  const apiKey = 'fb135a94c0574db4b26082b70705b4af';
  const tbody = document.getElementById('metar-data');
  const alertSound = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

  async function fetchMetars() {
    try {
      const res = await fetch(`https://api.checkwx.com/metar/${stations.join(',')}/decoded`, {
        headers: { 'X-API-Key': apiKey }
      });
      const json = await res.json();

      const rawRes = await fetch(`https://api.checkwx.com/metar/${stations.join(',')}`, {
        headers: { 'X-API-Key': apiKey }
      });
      const rawJson = await rawRes.json();
      const rawMap = {};
      rawJson.data.forEach(r => {
        const code = r.split(' ')[0];
        rawMap[code] = r;
      });

      const data = {};
      let shouldAlert = false;

      json.data.forEach(r => {
        const gusting = r.wind?.gust_kts;
        const hasWeather = r.conditions?.length > 0;
        if (gusting || hasWeather) shouldAlert = true;

        const clouds = (r.clouds || []).map(c => {
          const base = c.base_feet_agl ? `${c.base_feet_agl} ft` : '—';
          return `${c.text} (${base})`;
        }).join(', ') || '—';

        const hpa = r.barometer?.hpa;
        const inhg = r.barometer?.hg;

        data[r.icao] = {
          time: r.observed || '—',
          temperature: r.temperature?.celsius + ' °C' || '—',
          dewpoint: r.dewpoint?.celsius + ' °C' || '—',
          wind: r.wind
            ? `${r.wind.degrees}° – ${r.wind.speed_kts} kt${gusting ? ' gusting ' + gusting + ' kt' : ''}`
            : '—',
          visibility: r.visibility?.meters + ' m' || '—',
          conditions: hasWeather ? r.conditions.map(c => c.text).join(', ') : '—',
          clouds: clouds,
          altimeter: (hpa && inhg) ? `${hpa} – ${inhg}` : '—',
          raw_metar: rawMap[r.icao] || '—'
        };
      });

      if (shouldAlert) {
        alertSound.play().catch(() => {});
      }

      const parameters = [
        'time', 'temperature', 'dewpoint', 'wind',
        'visibility', 'conditions', 'clouds',
        'altimeter', 'raw_metar'
      ];

      const labels = {
        time: 'Time',
        temperature: 'Temperature (°C)',
        dewpoint: 'Dewpoint (°C)',
        wind: 'Wind',
        visibility: 'Visibility (m)',
        conditions: 'Conditions',
        clouds: 'Clouds (Base Height)',
        altimeter: 'Altimeter',
        raw_metar: 'Raw METAR'
      };

      const rows = parameters.map(param => {
        return `<tr><td>${labels[param]}</td>` +
          stations.map(code => {
            const value = data[code]?.[param] || '—';
            let className = '';
            if (param === 'wind' && value.includes('gusting')) className = 'alert-gust';
            if (param === 'conditions' && value !== '—') className = 'alert-weather';
            return `<td class="${className}">${value}</td>`;
          }).join('') +
          '</tr>';
      }).join('');

      tbody.innerHTML = rows;
    } catch (err) {
      console.error('Error loading METAR:', err);
      tbody.innerHTML = `<tr><td colspan="5">⚠️ Error loading data. Check connection or API key.</td></tr>`;
    }
  }

  fetchMetars();
  setInterval(fetchMetars, 5 * 60 * 1000); // Refresh every 5 min
</script>

</body>
</html>
